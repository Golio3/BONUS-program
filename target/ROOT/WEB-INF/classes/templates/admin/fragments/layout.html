<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/3.3.7/css/bootstrap.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/jstree/3.3.7/themes/default/style.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/summernote/0.8.10/summernote.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.manage.css}"/>

    <title layout:title-pattern="$CONTENT_TITLE | $LAYOUT_TITLE">Plastic Surgery ISCARE Prague</title>
</head>
<body>
<th:block th:replace="admin/fragments/header :: header"/>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2">
            <th:block th:replace="admin/fragments/sidebar :: sidebar"/>
        </div>
        <div class="col-md-10 main">
            <div>
                <th:block layout:fragment="content"/>
            </div>
        </div>
    </div>
</div>
<th:block th:replace="admin/fragments/footer :: footer"/>


<script th:src="@{/webjars/jquery/3.2.1/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/3.3.7/js/bootstrap.min.js}"></script>
<script th:src="@{/webjars/summernote/0.8.10/summernote.js}"></script>
<script th:src="@{/webjars/jstree/3.3.7/jstree.min.js}"></script>
<script th:inline="javascript">
    $(window).on('load', function () {
        var list = [[${pages}]];

        list.forEach(function (value) {
            if (value.type === 0) {
                value.type = 'folder';
            } else {
                value.type = 'file';
            }
        });

        function list_to_tree(list) {
            var root = {'id': 0, 'text': 'pages', 'type': 'folder', 'children': []};
            var map = new Map();
            var node, roots = [], i;
            for (i = 0; i < list.length; i += 1) {
                map.set(list[i].id, i);
                list[i].children = [];
            }

            for (i = 0; i < list.length; i += 1) {
                node = list[i];
                if (node.parentId !== 0) {
                    pId = node.parentId;
                    list[map.get(pId)].children.push(node);
                } else {
                    root.children.push(node);
                }
            }
            roots.push(root);
            return roots;
        }

        $(function () {
            treePage = $("#treePage");

            treePage.jstree({
                "types": {
                    "folder": {
                        "icon": "glyphicon glyphicon-folder-open"
                    },
                    "file": {
                        "icon": "glyphicon glyphicon-file"
                    }
                },
                "core": {
                    'data': list_to_tree(list),
                    "check_callback": function (operation, node, node_parent, node_position, more) {
                        if (operation === 'move_node') {
                            if (node_parent.type === 'folder') {
                                return true
                            } else
                                return false;
                        }
                        if (operation === 'delete_node') {
                            if (node.children.length > 0) {
                                alert("Can't delete. This node have children.");
                                return false;
                            } else
                                return true;
                        }
                    }
                },
                "dnd": {
                    "is_draggable": function (node) {
                        console.log('is_draggable called: ', node[0]);
                        return true;
                    }
                },
                "plugins": ["contextmenu", "types", "dnd"],
                "contextmenu": {
                    items: function ($node) {
                        var tree = $("#treePage").jstree(true);

                        var items = {
                            createFolder: {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "Create folder",
                                "action": function (obj) {
                                    newNode = $node;
                                    newNode = tree.create_node(newNode, {"type": "folder"});
                                    tree.edit(newNode);
                                }
                            },
                            createPage: {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "Create page",
                                "action": function (obj) {
                                    newNode = $node;
                                    newNode = tree.create_node(newNode, {"type": "file"});
                                    tree.edit(newNode);
                                }
                            },
                            rename: {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "Rename",
                                "action": function (obj) {
                                    tree.edit($node);
                                }
                            },
                            remove: {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "Remove",
                                "action": function (obj) {
                                    tree.delete_node($node);
                                }
                            },
                            editPage: {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "Go to the edit item",
                                "action": function (obj) {
                                    window.location.href = '/manage/page/page-edit/' + $node.id;
                                    //-- redirect?
                                }
                            }
                        };
                        if ($node.type === 'folder') {
                            delete items.editPage;
                            if ($node.id === 0 || $node.id === 'j1_1') {
                                delete items.rename;
                                delete items.remove;
                            } else {
                                delete items.createFolder;
                            }
                        } else {
                            delete items.createFolder;
                            delete items.createPage;
                        }
                        return items;
                    }
                }
            }).on('create_node.jstree', function (e, data) {
                $.ajax({
                    type: "POST",
                    url: "/manage/page/create-node",
                    data: {
                        id: data.node.id,
                        text: data.node.text,
                        parentId: changeParent(data.parent),
                        type: data.node.type,
                        position: data.position
                    },
                    dataType: 'json',
                    timeout: 600000,
                    success: function (postData) {
                    },
                    error: function (err) {
                    }
                });
                // window.location.reload();
            }).on('rename_node.jstree', function (e, data) {
                $.ajax({
                    type: "POST",
                    url: "/manage/page/rename-node",
                    data: {
                        id: data.node.id,
                        text: data.node.text
                    },
                    dataType: 'json',
                    timeout: 600000,
                    success: function (postData) {
                    },
                    error: function (err) {
                    }
                });
            }).on('delete_node.jstree', function (e, data) {
                $.ajax({
                    type: "POST",
                    url: "/manage/page/delete-node",
                    data: {
                        id: data.node.id
                    },
                    dataType: 'json',
                    timeout: 600000,
                    success: function (postData) {
                    },
                    error: function (err) {
                    }
                });
            }).on('move_node.jstree', function (e, data) {
                $.ajax({
                    type: "POST",
                    url: "/manage/page/move-node",
                    data: {
                        id: data.node.id,
                        parentId: changeParent(data.parent),
                        position: data.position
                    },
                    dataType: 'json',
                    timeout: 600000,
                    success: function (postData) {
                    },
                    error: function (err) {
                    }
                });
            });
        });
    });


</script>
<script th:inline="javascript" th:src="@{/js/main.js}"></script>
</body>
</html>